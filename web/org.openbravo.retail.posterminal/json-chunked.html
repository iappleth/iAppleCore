<!DOCTYPE html>
<html>
<head>
<title>JSON chunked</title>
<script src="js/libs/jquery-1.7.2.min.js"></script>
<script src="js/libs/underscore-1.3.3.min.js"></script>
</head>
<body>
<script>
window.onerror = function (msg, url, line) {
  alert(msg + ' - ' + url + ':' + line);
}

var count = 0;
var dbSize = 10 * 1024 * 1024;
var db = openDatabase("POS", "1.0", "POS Cache", dbSize);

function log() {
  console.log(arguments);
}

function dbSuccess() {
}

function dbError() {
  alert('Error!!!');
  console.log(arguments);
}


db.transaction(function(tx) {
  tx.executeSql("CREATE TABLE IF NOT EXISTS " +
                "products(id TEXT PRIMARY KEY, name TEXT)", [], dbSuccess, dbError);
});

db.transaction(function (tx) {
  tx.executeSql('DELETE FROM products', null, dbSuccess, dbError);
}, null, function() {

  var d1 = Date.now();
  $.ajax({
    url: '/openbravo/org.openbravo.retail.posterminal.datasource/Product',
    dataType: 'json',
    cache: false,
    error: function (jqXHR, textStatus, errorThrown) {
      console.log(arguments);
    },
    success: function (data, textStatus, jqXHR) {
      var q = "INSERT INTO products (id, name) VALUES (?,?)";

      db.transaction(function (tx) {
        _.each(data.data, function (item) {
          tx.executeSql(q, [item.id, item._identifier], dbSuccess, dbError);
        });
      }, dbError,
      function () {
        alert('20K inserts in: ' + (Date.now() - d1) + 'ms');
      });
    },
    complete: function (jqXHR, textStatus) {
      console.log('complete!')
    }
  });
}, dbError);
</script>
</body>
</html>