<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Load Test</title>
<style>
applet {
 position: absolute;
 left: -9999em;
}
</style>
</head>
<body>
<script src="js/libs/jquery-1.7.2.js"></script>
<script src="js/libs/underscore-1.3.3.js"></script>
<script src="js/libs/backbone-0.9.2.js"></script>
<script src="js/model/product.js"></script>
<script src="js/20k-products.js"></script>
<!-- <script src="http://192.168.7.197:8180/target/target-script-min.js#anonymous"></script>  -->
<button id="load">Load Products</button>
<button id="count">Count</button>
<button id="find">Find</button>
<br>
<span id="log"></span>
</div>
<script>
window.onerror = function (msg, url, line) {
  alert(msg + ' - ' + url + ':' + line);
}

function dbSuccess() {
}

function dbError() {
  alert('Error!!!');
  console.log(arguments);
}

var dbSize = 10 * 1024 * 1024;
var db = openDatabase("POS", "1.0", "POS Cache", dbSize);

db.transaction(function(tx) {
  tx.executeSql("CREATE TABLE IF NOT EXISTS " +
                "products(id TEXT PRIMARY KEY, name TEXT)", [], dbSuccess, dbError);
});

function fetch(startRow, batchSize, timestamp) {
  var data = {
    _startRow: startRow,
    _endRow: startRow + batchSize,
    _sortBy: 'name'//,
    //_noCount: false
  };

  products.fetch({
    data: data,
    success: function () {
      var models = products.models,
          len = models.length,
          q = "INSERT INTO products (id, name) VALUES (?,?)";

      db.transaction(function (tx) {
        _.each(models, function (item) {
          tx.executeSql(q, [item.id, item.attributes.name], dbSuccess, dbError);
        });
      });

      $('#log').text($('#log').text() + '.');

      if(len === batchSize) {
        fetch(startRow + batchSize + 1, batchSize, timestamp);
      } else {
        alert('Load took: ' + (Date.now() - timestamp) + 'ms');
        $('#load').removeAttr('disabled');
        $('#find').removeAttr('disabled');
        $('#count').removeAttr('disabled');
        $('#load').text('Load Products');
        $('#log').text('');
      }
    },
    error: function () {
      console.trace();
      console.log('error');
    }
  });
}

function fetch2() {
  var q = "INSERT INTO products (id, name) VALUES (?,?)";
  var ti1 = Date.now();

  db.transaction(function (tx) {
    _.each(data, function (item) {
      tx.executeSql(q, [item.id, item.name], dbSuccess, dbError);
    });
  }, dbError, function () {
    alert('20K inserts in: ' + (Date.now() - ti1) + 'ms');
    $('#load').removeAttr('disabled');
    $('#find').removeAttr('disabled');
    $('#count').removeAttr('disabled');
    $('#load').text('Load Products');
    $('#log').text('')
    });
}

var products = new OB.Model.Products;

$('#load').click(function () {

  var t1, batchSize = 1000;

  $('#load').text('Loading...');
  $('#load').attr('disabled', 'disabled');
  $('#find').attr('disabled', 'disabled');
  $('#count').attr('disabled', 'disabled');

  db.transaction(function(tx) {
    tx.executeSql("DELETE FROM products", null, function () {
      t1 = Date.now();
      fetch2(); // fetch(0, batchSize, t1);
    }, dbError);
  });
});

$('#count').click(function () {
  db.transaction(function(tx) {
    var tc = Date.now();
    tx.executeSql('SELECT count(*) AS total FROM products',
                  null,
                  function(tx, rs) {
                    alert('Count: ' + rs.rows.item(0).total + ' in ' + (Date.now() - tc));
                  }, dbError);
                });
});

$('#find').click(function () {
  db.transaction(function(tx) {
    var ts = Date.now();
    tx.executeSql('SELECT * FROM products WHERE id = ?',
                  ['E02489C188B54EABB8519F96F53E9077'],
                  function(tx, rs) {
                    alert('row found: ' + rs.rows.item(0).name + ' in ' + (Date.now() - ts));
                  }, dbError);
                });
});
</script>
</body>
</html>