<?xml version="1.0" encoding="UTF-8"?>
<!--
 ************************************************************************************
 * Copyright (C) 2012-2019 Openbravo S.L.U.
 * Licensed under the Openbravo Commercial License version 1.0
 * You may obtain a copy of the License at http://www.openbravo.com/legal/obcl.html
 * or in the legal folder of this module distribution.
 ************************************************************************************
-->

<output>
  <ticket>
    <line>
        <image>ticket-image.png</image>
    </line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_Quotation_Title'))%></text>
    </line>
    <line></line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckheader_line1'))%></text>
    </line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckheader_line2'))%></text>
    </line>
    <line></line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_ticket')) %></text>
      <text><%= OB.UTIL.encodeXMLComponent(order.get('documentNo')) %></text>
    </line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_datetime')) %></text>
      <text><%= OB.I18N.formatDate(new Date()) %></text>
      <text> </text>
      <text><%= OB.I18N.formatHour(new Date()) %></text>
    </line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_cashierPOS')) %></text>
      <text><%= OB.UTIL.encodeXMLComponent(order.get('salesRepresentative'+OB.Constants.FIELDSEPARATOR + OB.Constants.IDENTIFIER)) %></text>
      <text>, </text>
      <text><%= OB.UTIL.encodeXMLComponent(order.get('posTerminal'+OB.Constants.FIELDSEPARATOR + OB.Constants.IDENTIFIER)) %></text>
    </line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LblTaxId')) %></text>
      <text><%= OB.MobileApp.model.get('terminal').organizationTaxId %></text>
    </line>
    <line></line>
    <line>
      <text align ="left" length="21"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LineItem'))%></text>
      <text align ="right" length="5">#</text>
      <text align ="right" length="8"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LinePrice'))%></text>
      <text align ="right" length="8"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LineTotal'))%></text>
    </line>
    <line>
      <text>------------------------------------------</text>
    </line>
    <% 
      var lines = order.get('lines'), line, promotions;
      for (var i = 0; i < lines.length; i++) {
        line = lines.at(i);
    %>
      <line>
        <text align ="left" length="21"><%= OB.UTIL.encodeXMLComponent(line.get('product').get('_identifier')) %></text>
        <text align ="right" length="5"><%= line.printQty() %></text>
        <text align ="right" length="8"><%= line.printPrice() %></text>
    <%if(order.get('priceIncludesTax')){%>
        <text align ="right" length="8"><%= line.printGross() %></text>  
    <%}else{%>
        <text align ="right" length="8"><%= line.printNet() %></text>
    <%}%>
      </line>
    <%if(line.has('organization') && line.get('organization').id !== OB.MobileApp.model.get('terminal').organization){%>
      <line>
        <text align ="right">-- <%= line.get('organization').name %></text>  
      </line>
    <%}
    var deliveryDate = line.get('obrdmDeliveryDate') ? (line.get('obrdmDeliveryDate') instanceof Date ? line.get('obrdmDeliveryDate') : new Date(line.get('obrdmDeliveryDate'))) : null,
        deliveryTime = line.get('obrdmDeliveryTime') ? (line.get('obrdmDeliveryTime') instanceof Date ? line.get('obrdmDeliveryTime') : new Date(line.get('obrdmDeliveryTime'))) : null,
        showDate = line.get('obrdmDeliveryMode') === 'PickupInStoreDate' || line.get('obrdmDeliveryMode') === 'HomeDelivery',
        showTime = line.get('obrdmDeliveryMode') === 'HomeDelivery',
        deliveryName = line.get('nameDelivery') ? line.get('nameDelivery') : (line.get('obrdmDeliveryMode') ? _.find(OB.MobileApp.model.get('deliveryModes'), function (dm) {
           return dm.id === line.get('obrdmDeliveryMode');
         }).name : null);
     
     if (line.get('obrdmDeliveryMode') && deliveryName && (line.get('obrdmDeliveryMode') !== order.get('obrdmDeliveryModeProperty') || deliveryDate)) {
      var currentDate, currentTime;
      if (!deliveryDate) {
        currentDate = new Date();
        currentDate.setHours(0);
        currentDate.setMinutes(0);
        currentDate.setSeconds(0);
      }

      if (!deliveryTime) {
        currentTime = new Date();
        currentTime.setSeconds(0);
      }
     %>
      <line>
          <text align ="right">-- <%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBRDM_DeliveryMode'))%>: <%=deliveryName%></text>
      </line>
     <% if(showDate){%>
		<line>
          <text align ="right">-- <%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBRDM_DeliveryDate'))%>: <%=deliveryDate ? OB.I18N.formatDate(deliveryDate) : OB.I18N.formatDate(currentDate)%></text>
        </line>         
     <%}
      if(showTime){%>
		<line>
          <text align ="right">-- <%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBRDM_DeliveryTime'))%>: <%=deliveryTime ? OB.I18N.formatHour(deliveryTime) : OB.I18N.formatHour(currentDate)%></text>
        </line>
      <%}
     }
        promotions = line.get('promotions');
        if (promotions){
          promotions.forEach(function(p) {
            if (!p.hidden) {
            %>
          <line>
            <text align="left" length="2">--</text>
            <text align="left" length="32"><%= OB.UTIL.encodeXMLComponent(p.name) %></text>
            <text align="right" length="8"><%= OB.I18N.formatCurrency(-p.amt) %></text>
          </line>
          <%
            }
          });
        }
      }
    %>
    <%if(!order.get('priceIncludesTax')){%>
      <line>
        <text align ="left" length="21"><%= OB.I18N.getLabel('OBPOS_LblTotalTax') %></text>
        <text align ="right" length="5"></text>
        <text align ="right" length="8"></text>
        <text align ="right" length="8"><%= OB.I18N.formatCurrency(OB.DEC.sub(order.getGross() , order.getNet())) %></text>  
      </line>
    <%}%>
    <line></line>
    <line size="1">
      <text align ="left" length="25"><%=OB.I18N.getLabel('OBPOS_ReceiptTotal') + ' ' + order.get('currency' + OB.Constants.FIELDSEPARATOR + OB.Constants.IDENTIFIER) %></text>
      <text align ="right" length="14"><%= order.printGross() %></text>
    </line>   
    <line></line>
    <line size="1">
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_Quotation_Title')) %></text>
    </line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckfooter_line2'))%></text>
    </line>
    <line></line>
    <line>
      <text align ="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_breakdown'))%></text>
      <text align ="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_base'))%></text>
      <text align ="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_TAX'))%></text>
    </line>
    <line>
      <text>------------------------------------------</text>
    </line>
    <%
      var totAmount = 0;
      var taxes = order.get('taxes');
      for (var t in taxes) {
        totAmount += taxes[t].amount;
    %>
      <line>
        <text align ="left" length="12"><%= OB.I18N.formatRate(taxes[t].rate) %></text>
        <text align ="left" length="12"><%= OB.I18N.formatCurrency(taxes[t].net) %></text>
        <text align ="left" length="12"><%= OB.I18N.formatCurrency(taxes[t].amount) %></text>
      </line>
    <%
      }
    %>
    <line>
      <text>------------------------------------------</text>
    </line>
    <line>
      <text align ="left" length="24"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_display_total'))%></text>
      <text align ="left" length="12"><%= OB.I18N.formatCurrency(totAmount) %></text>
    </line>

    <line>
      <barcode type="CODE128" position="left"><%= OB.UTIL.encodeXMLComponent(order.getScannableDocumentNo()) %></barcode>
    </line>

  </ticket>

</output>