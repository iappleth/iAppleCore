<?xml version="1.0" encoding="UTF-8"?>
<!--
 ************************************************************************************
 * Copyright (C) 2018-2021 Openbravo S.L.U.
 * Licensed under the Openbravo Commercial License version 1.0
 * You may obtain a copy of the License at http://www.openbravo.com/legal/obcl.html
 * or in the legal folder of this module distribution.
 ************************************************************************************
-->

<output>
  <ticket>
    <line>
        <image>ticket-image.png</image>
    </line>
    <line></line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckheader_line1')) %></text>
    </line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckheader_line2')) %></text>
    </line>
    <line></line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_ticket')) %></text>
      <text><%= OB.UTIL.encodeXMLComponent(ticket.documentNo) %></text>
    </line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_datetime')) %></text>
      <text><%= OB.I18N.formatDate(ticket.orderDate) %></text>
      <text> </text>
      <%
        const ticketTime = ticket.creationDate != null ? new Date(ticket.creationDate) : ticket.created != null ? new Date(ticket.created) : new Date();
      %>
      <text><%= OB.I18N.formatHour(ticketTime) %></text>
    </line>
    <line>
      <text align="left" length="22"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_cashierPOS')) %></text>
      <text><%= OB.UTIL.encodeXMLComponent(ticket['salesRepresentative$_identifier']) %></text>
      <text>, </text>
      <text><%= OB.UTIL.encodeXMLComponent(ticket['posTerminal$_identifier']) %></text>
    </line>
    <line></line>
    <line size="1">
    <% if (ticket.fromLayaway) { %>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_CanceledLayaway_Title')) %></text>
    <% } else { %>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_CanceledOrder_Title')) %></text>
    <% } %>
    </line>
    <line size="1">
    </line>
     <line></line>
    <line>
      <text align="left" length="21"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LineItem')) %></text>
      <text align="right" length="5">#</text>
      <text align="right" length="8"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LinePrice')) %></text>
      <text align="right" length="8"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_LineTotal')) %></text>
    </line>
    <line>
      <text>------------------------------------------</text>
    </line>
    <% 
      ticket.lines.forEach(line => {
    %>
      <line>
        <text align="left" length="21"><%= OB.UTIL.encodeXMLComponent(line.product._identifier) %></text>
        <text align="right" length="5"><%= OB.App.PrintUtils.printQty(line.qty) %></text>
        <text align="right" length="8"><%= OB.App.PrintUtils.printTicketLinePrice(line) %></text>
        <text align="right" length="8"><%= OB.App.PrintUtils.printTicketLineAmount(line) %></text>
      </line>
    <%
        if (line.promotions) {
          line.promotions.forEach(p => {
            if (!p.hidden) {
            %>
          <line>
            <text align="left" length="2">--</text>
            <text align="left" length="32"><%= OB.UTIL.encodeXMLComponent(p.name) %></text>
            <text align="right" length="8"><%= OB.App.PrintUtils.printAmount(-p.amt) %></text>
          </line>
    <%
            }
          });
        }
      });
    %>
    <% if (!ticket.priceIncludesTax) { %>
      <line>
        <text align="left" length="21"><%= OB.I18N.getLabel('OBPOS_LblTotalTax') %></text>
        <text align="right" length="5"></text>
        <text align="right" length="8"></text>
        <text align="right" length="8"><%= OB.App.PrintUtils.printAmount(OB.DEC.sub(ticket.grossAmount, ticket.netAmount)) %></text>
      </line>
    <% } %>
    <line></line>
    <line size="1">
      <text align="left" length="25"><%= OB.I18N.getLabel('OBPOS_ReceiptTotal') + ' ' + ticket['currency$_identifier'] %></text>
      <text align="right" length="14"><%= OB.App.PrintUtils.printAmount(ticket.grossAmount) %></text>
    </line> 
    <%
      const payments = ticket.payments || [];
      payments.forEach(payment => {
        let paymentName = payment.name;
        if (payment.rate && payment.rate !== '1') {
    %>
        <line>
          <text align="left" length="15"><%= payment.name %></text>
          <text align="right" length="12"><%= '(' + OB.App.PrintUtils.printAmount(payment.amount) + ' ' + payment.isocode + ')' %></text>
          <text align="right" length="13"><%= OB.App.PrintUtils.printAmount(payment.origAmount) %></text>
        </line>
     <%
        } else {
     %>
        <line>
          <text align="left" length="20"><%= payment.name %></text>
          <text align="right" length="20"><%= OB.App.PrintUtils.printAmount(payment.amount) %></text>
        </line>
      <%
        }
        if (payment.gatewayData) {
          const pinfo = payment.gatewayData;
      %>
        <line>
          <text align="left" length="2"></text>
          <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_PaymentTran') %></text>
          <text align="left" length="20"><%= pinfo.transaction %></text>
        </line>      
        <line>
          <text align="left" length="2"></text>
          <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_PaymentApproval') %></text>
          <text align="left" length="20"><%= pinfo.authorization %></text>
        </line>      
        <% if (pinfo.cardmasked) { %>
        <line>
          <text align="left" length="2"></text>
          <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_PaymentAct') %></text>
          <text align="left" length="20"><%= pinfo.cardmasked %></text>
        </line>  
        <% } %>
        <% if (pinfo.cardlogo) { %>    
        <line>
          <text align="left" length="2"></text>
          <text align="left" length="20"><%= OB.I18N.getLabel('OBPOS_PaymentLogo') %></text>
          <text align="left" length="20"><%= pinfo.cardlogo %></text>
        </line>
        <% } %>    
    <%
        }
      });
    %>
    <line>
      <text align="left" length="20"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_ticketChange')) %></text>
      <text align="right" length="20"><%= OB.I18N.formatCurrency(ticket.change) %></text>
    </line>
    <line></line>
    <line size="1">
    </line>
    <line>
      <text align="center" length="42"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tckfooter_line2')) %></text>
    </line>
    <line></line>
    <line>
      <text align="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_breakdown')) %></text>
      <text align="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_base')) %></text>
      <text align="left" length="12"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_tck_TAX')) %></text>
    </line>
    <line>
      <text>------------------------------------------</text>
    </line>
    <%
      let totAmount = 0;
      const taxes = Object.values(ticket.taxes).sort((a, b) => a.name.localeCompare(b.name));
      taxes.forEach(tax => {
        totAmount += tax.amount;
    %>
      <line>
        <text align="left" length="12"><%= OB.I18N.formatRate(tax.rate) %></text>
        <text align="left" length="12"><%= OB.App.PrintUtils.printAmount(tax.net) %></text>
        <text align="left" length="12"><%= OB.App.PrintUtils.printAmount(tax.amount) %></text>
      </line>
    <%
      });
    %>
    <line>
      <text>------------------------------------------</text>
    </line>
    <line>
      <text align="left" length="24"><%= OB.UTIL.encodeXMLComponent(OB.I18N.getLabel('OBPOS_display_total')) %></text>
      <text align="left" length="12"><%= OB.I18N.formatCurrency(totAmount) %></text>
    </line>

    <line>
      <% if (ticket.documentNo !== '') { %>
        <barcode type="CODE128" position="left"><%= OB.UTIL.encodeXMLComponent(ticket.documentNo) %></barcode>
      <% } %>
    </line>

  </ticket>

</output>